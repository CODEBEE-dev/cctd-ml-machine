<html>
<head>

</head>
<body>
<button onclick="request()">Test</button>
<p id="output"></p>
<script>
    const outputElem = document.getElementById("output")
    let device = undefined
    const connect = () => {
        if (!device) {
            throw Error("BtDevice not set")
        }
        device.gatt.connect().then(() => {
            listenToServices();
        }).catch(e => console.log(e))
    }

    const accelChange = (x, y, z) => {
        const out = `x: ${x} y: ${y} z: ${z}`
        outputElem.innerHTML = out
    }

    const listenToServices = () => {
            console.log("Connected")
            device.gatt.getPrimaryService(
                "e95d0753-251d-470a-a062-fa1922dfa9a8"
            ).then((service) => {
                service.getCharacteristic("e95dca4b-251d-470a-a062-fa1922dfa9a8").then((characteristic) => {
                    characteristic.startNotifications().then(() => {
                        characteristic.addEventListener("characteristicvaluechanged",
                            (event) => {
                                const target = event.target;
                                const x = target.value.getInt16(0, true);
                                const y = target.value.getInt16(2, true);
                                const z = target.value.getInt16(4, true);
                                accelChange(x, y, z);
                            })
                        console.log("Started notifications")
                    })
                    console.log("Got characteristics")
                })
                console.log("Found service!")
            }).catch(e => console.log(e));
    }

    const request = () => {
        navigator.bluetooth
            .requestDevice({
                filters: [{ namePrefix: `BBC micro:bit` }],
                optionalServices: [
                    "e95d0753-251d-470a-a062-fa1922dfa9a8",
                    "0000180a-0000-1000-8000-00805f9b34fb",
                    "e95d9882-251d-470a-a062-fa1922dfa9a8"
                ]
            })
            .then((btDevice) => {
                device = btDevice;
                connect();
                device.addEventListener(
                    "gattserverdisconnected",
                    connect
                );
            }).catch(e => {console.log(e)});
    }
</script>
</body>
</html>